<script>
    window.processData = function (epics, ignoreEmpty) {
        console.log('data in', epics);
        var retval = [];

        var epicWeight = 4;
        var storyWeight = 2;
        var subtaskWeight = 1;

        epics.forEach(function (epic) {
            var storyPointSum = 0;
            var tasksTotal = 0;
            var tasksDone = 0;
            var timeSpent = 0;
            var percentage = 0;

            tasksTotal += epicWeight;
            if (epic.statusName === 'Closed') {
                tasksDone += epicWeight;
            }

            epic.children.forEach(function (story) {
                if (story.sp) {
                    storyPointSum += story.sp;
                }
                if (story.aggregateTimeSpent) {
                    timeSpent += story.aggregateTimeSpent;
                }

                tasksTotal += storyWeight;
                if (epic.statusName === 'Closed' || story.statusName === 'Closed') {
                    tasksDone += storyWeight;
                }

                if (story.children) {
                    story.children.forEach(function (subtask) {
                        tasksTotal += subtaskWeight;
                        if (epic.statusName === 'Closed' || story.statusName === 'Closed' || subtask.statusName === 'Closed') {
                            tasksDone += subtaskWeight;
                        }
                    });
                }
            });
            if (epic.aggregateTimeSpent) {
                timeSpent += epic.aggregateTimeSpent;
            }
            if (storyPointSum === 0) {
                percentage = 0;
            } else {
                percentage = tasksDone / tasksTotal;
            }
            if(ignoreEmpty && storyPointSum === 0){
                return;
            }
            retval.push([epic.summary, storyPointSum, storyPointSum * percentage, timeSpent / 3600 / 8.4]);
        });
        console.log("epics", retval.length, retval);
        return retval;
    };
</script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://raw.githack.com/brookman/jira/7287591c4153659e38a6827af852bb997058e7a2/src/js/jira-utils.js"></script>
<script src="https://rawgit.com/brookman/jira/7287591c4153659e38a6827af852bb997058e7a2/src/js/project-overview.js"></script>
<div><textarea id="epicsJson">
[]
</textarea>
    <button id="loadDataButton">Load data from JIRA</button>
    <input id="ignoreEmptyEpicsCheckbox" type="checkbox">Ignore epics without story points<input>
    <button id="generateChartButton">Generate chart</button>
</div>
<div id="overview_epics_chart"></div>
<div id="overview_epics"></div>